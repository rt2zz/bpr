extends layout

block content

  body

    .limitS
      h1 Edit Product

    .limitS
      form(method='post', action='/products/update', enctype="multipart/form-data")
        if(typeof isNew != 'undefined') 
          input(name="isNew", type="hidden", value=isNew)
        .section
          .row
            label ID
            input(name='_id', type="textfield", value=product._id, readonly)
          .row
            label Status
            select(name='status', type="checkbox")
              option(value=2, selected=(product.status==2)) Active
              option(value=1, selected=(product.status==1)) Unpublished
              option(value=0, selected=(product.status==0)) Trash
          .row
            label Name
            input(name='name', type='textfield', value=product.name)
          .row
            label Description
            textarea(name='desc')= product.desc
          hr
          .row
            input(name="media", type="hidden", value=JSON.stringify(product.media))
            label Media
            .options
              a.imageButton(href="#") Image
              span &nbsp;-&nbsp;
              a.embedButton(href="#") Embed
            .thumbs
        .spacer
        .section.action
          .row
            input(type='submit', value="upload")

block footer
  script(src=protocol+"://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js")
  script.

    function mediaAddItem(type, data, container){
      container.append(mediaGenerateThumb(data));
    }

    function mediaGenerateThumb(data){
      if(data.type == 'image'){
        var prefix = (typeof data.new === 'undefined' ? '//' : '')
        var thumb = "<div class='mediaItem' mediaType='"+data.type+"' data='"+JSON.stringify(data)+"'><a href='#' class='mediaMover left' direction='up'>"
        thumb += "<<a><img src='"+prefix+data.path+"' height='70px' />"
        thumb += '<a href="#" class="mediaMover right" direction="down">></a><a href="#" class="mediaDeleter">x</a></div>';
        return thumb;
      }
      if(data.type == 'embed'){
        var thumb = "<div class='mediaItem' mediaType='"+data.type+"' data='"+JSON.stringify(data)+"'><a href='#' class='mediaMover left' direction='up'>"+"<<a>"
        thumb += data.embed;
        thumb += "<a href='#=' class='mediaMover right' direction='down'>></a><a href='#' class='mediaDeleter'>x</a></div>";
        return thumb;
      }
    }

    function processMedia(container){
      media=[];
      container.children().each(function(i, item){
        data = JSON.parse($(item).attr('data'));
        media.push(data);
      });
      console.log('stringified:', JSON.stringify(media));
      $('input[name="media"]').val(JSON.stringify(media));
    }

    var media = [];

    $(document).ready(function(){

      //generate thumbs off initial media data
      var initialMedia = JSON.parse($('input[name="media"]').val());
      $(initialMedia).each(function(i, item){
        $('.thumbs').append(mediaGenerateThumb(item));
      });

      var imageUploader = $('<input name="imageUploader" type="file">');

      imageUploader.change(function(){
        var file = this.files[0];

        function imageSuccess(data){
          var container = $('.thumbs');
          mediaAddItem('image', data, container);
          processMedia(container);
        }

        var req = this.req = new XMLHttpRequest;
        req.open('POST', '/upload');
        req.onreadystatechange = function(){
          console.log('upload')
          console.log(req.readyState)
          if (4 == req.readyState) {
            var type = req.status / 100 | 0;
            if (2 == type) imageSuccess($.parseJSON(req.responseText));
            //- var err = new Error(req.statusText + ': ' + req.response);
            //- err.status = req.status;
            //- console.log(err)
          }
        };

        var body = new FormData;
        body.append('file', file);
        console.log(body);
        req.send(body);
      });

      $('.imageButton').click(function(){
        imageUploader.click();
      });

      $('.thumbs').on('click', '.mediaMover', function(e){
        e.preventDefault();
        var mover = $(this).closest('.mediaItem');
        if($(this).attr('direction') == 'up'){
          mover.prev().before(mover);
        }
        else{
          mover.next().after(mover);
        }
        processMedia($('.thumbs'));
      });

      $('.thumbs').on('click', '.mediaDeleter', function(e){
        e.preventDefault();
        $(this).closest('.mediaItem').remove();
        processMedia($('.thumbs'));
      })

      $('.embedButton').click(function(){
        $olay = $('<div class="olay"><div class="center"><div class="centered"><input name="embed" type="text" placeholder="embed code" /><a class="go" href="#"><i class="icon-2x icon-circle-arrow-right"></i></a></div></div></div>');
        $olay.appendTo($('body')).find('input').focus()
        
        //Close on esc
        $(document).keyup(function(e) {
          //@TODO remove this binding when olay is removed
          if (e.keyCode == 27) { $olay.remove()} 
        });

        $olay.find('.go').click(function(){
          var embed = $olay.find('input').val();
          data = {
            type: 'embed',
            embed: embed
          }
          mediaAddItem('embed', data, $('.thumbs'));
          processMedia($('.thumbs'));
          $olay.remove();
        })
      })

    });

